<script>
const MEDIA_URL = "https://raw.githubusercontent.com/beltedblinds/Idol-Categorizer/main/idol_gallery_links.txt";
const MEDIA_URL_02 = "https://raw.githubusercontent.com/beltedblinds/Idol-Categorizer/main/idol_gallery_links_02.txt";

let catalog = [];
let filteredCatalog = [];
let currentIdolFilter = null;
let currentCategoryFilter = null;
let categories = [];

const searchInput = document.getElementById("searchInput");
const searchBtn = document.getElementById("searchBtn");
const suggestionsEl = document.getElementById("suggestions");
const catalogPanel = document.getElementById("catalogPanel");
const idolButtonsEl = document.getElementById("idolButtons");
const categoryPanel = document.getElementById("categoryPanel");
const overlay = document.getElementById("overlay");

function parseCatalogText(text) {
  const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
  return lines.map(line => {
    const parts = line.split(",").map(p => p.trim());
    return { folder: parts[0], raw: parts[1], thumb: parts[2], category: parts[3] || ""};
  }).filter(e => e.folder && e.raw && e.thumb)
    .sort((a,b)=>a.folder.localeCompare(b.folder));
}

// --- FILTERING LOGIC ---
function applyFilters() {
  filteredCatalog = catalog.filter(item => {
    if (currentIdolFilter && item.folder !== currentIdolFilter) return false;
    if (currentCategoryFilter && item.category !== currentCategoryFilter) return false;
    return true;
  });

  // Compute available idols and categories based on filteredCatalog
  const availableIdols = [...new Set(filteredCatalog.map(it => it.folder))].sort();
  const availableCategories = [...new Set(filteredCatalog.map(it => it.category).filter(Boolean))].sort();

  renderIdolButtons(availableIdols);
  renderCategoryButtons(availableCategories);
  renderCatalogThumbnails();
}

function renderIdolButtons(list = null) {
  idolButtonsEl.innerHTML = "";
  const names = list || [...new Set(catalog.map(it => it.folder))];
  names.forEach(name => {
    const btn = document.createElement("button");
    btn.className = "idol-btn";
    btn.textContent = name;
    if (currentIdolFilter === name) btn.classList.add("active");
    btn.onclick = () => {
      currentIdolFilter = currentIdolFilter === name ? null : name;
      applyFilters();
    };
    idolButtonsEl.appendChild(btn);
  });
}

function renderCategoryButtons(list = null) {
  categoryPanel.innerHTML = "";
  const cats = list || [...new Set(catalog.map(it => it.category).filter(Boolean))];
  cats.forEach(cat => {
    const btn = document.createElement("button");
    btn.className = "category-btn";
    btn.textContent = cat;
    if (currentCategoryFilter === cat) btn.classList.add("active");
    btn.onclick = () => {
      currentCategoryFilter = currentCategoryFilter === cat ? null : cat;
      applyFilters();
    };
    categoryPanel.appendChild(btn);
  });
}

// --- SEARCH ---
function handleSearch(input) {
  const term = input.trim().toLowerCase();
  if (!term) {
    filteredCatalog = catalog.slice();
    applyFilters();
    suggestionsEl.hidden = true;
    return;
  }
  const matches = [...new Set(catalog.map(it => it.folder))].filter(f =>
    f.toLowerCase().includes(term)
  );
  showSuggestions(matches, term);
}

function showSuggestions(matches, term) {
  suggestionsEl.innerHTML = "";
  if (!matches.length) {
    suggestionsEl.innerHTML = `<div class="no-result">No results for "${term}"</div>`;
    suggestionsEl.hidden = false;
    return;
  }
  matches.forEach(folder => {
    const div = document.createElement("div");
    div.className = "suggestion";
    div.textContent = folder;
    div.onclick = () => selectFolder(folder);
    suggestionsEl.appendChild(div);
  });
  suggestionsEl.hidden = false;
}

function selectFolder(folder) {
  filteredCatalog = catalog.filter(it => it.folder.toLowerCase() === folder.toLowerCase());
  searchInput.value = folder;
  suggestionsEl.hidden = true;
  applyFilters();
}

// --- CATALOG THUMBNAILS & OVERLAY ---
function renderCatalogThumbnails() {
  const pool = filteredCatalog.length ? filteredCatalog : catalog;
  catalogPanel.innerHTML = "";
  pool.forEach(item => {
    const img = document.createElement("img");
    img.src = item.thumb || item.raw || item.url;
    img.className = "catalog-thumb";
    img.title = item.folder;
    img.onclick = () => toggleOverlay(item.raw);
    catalogPanel.appendChild(img);
  });
}

let overlayVisible = false;
function toggleOverlay(url) {
  if (overlayVisible) {
    overlay.style.display = "none";
    overlay.innerHTML = "";
    overlayVisible = false;
    return;
  }
  overlay.innerHTML = "";
  let media;
  if (url.match(/\.(mp4|webm|mov)$/i)) {
    media = document.createElement("video");
    media.src = url;
    media.autoplay = true;
    media.loop = true;
    media.muted = true;
    media.controls = true;
    media.playsInline = true;
  } else {
    media = document.createElement("img");
    media.src = url;
  }
  overlay.appendChild(media);
  overlay.style.display = "flex";
  overlayVisible = true;
}

overlay.addEventListener("click", () => {
  overlay.style.display = "none";
  overlay.innerHTML = "";
  overlayVisible = false;
});

// --- EVENT LISTENERS ---
searchBtn.addEventListener("click", () => handleSearch(searchInput.value));
searchInput.addEventListener("input", () => handleSearch(searchInput.value));
document.addEventListener("click", (e) => {
  if (!suggestionsEl.contains(e.target) && e.target !== searchInput) {
    suggestionsEl.hidden = true;
  }
});

// --- LOAD CATALOG ---
async function loadCatalog() {
  const [res1, res2] = await Promise.all([fetch(MEDIA_URL), fetch(MEDIA_URL_02)]);
  const txt1 = await res1.text();
  const txt2 = await res2.text();

  catalog = parseCatalogText(txt1 + "\n" + txt2);
  filteredCatalog = catalog.slice();
  categories = [...new Set(catalog.map(it => it.category).filter(Boolean))];

  applyFilters();
}

loadCatalog();
</script>
